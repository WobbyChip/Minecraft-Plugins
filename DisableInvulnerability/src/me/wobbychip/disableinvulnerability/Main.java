package me.wobbychip.disableinvulnerability;

import java.lang.reflect.InvocationTargetException;

import org.bukkit.Bukkit;
import org.bukkit.ChatColor;
import org.bukkit.event.EventHandler;
import org.bukkit.event.EventPriority;
import org.bukkit.event.Listener;
import org.bukkit.event.player.PlayerJoinEvent;
import org.bukkit.plugin.java.JavaPlugin;

public class Main extends JavaPlugin implements Listener {
	Class<?> CraftPlayer;

	public boolean fieldExists(Class<?> someClass, String fieldName) {
		try {
			someClass.getField(fieldName);
		} catch (SecurityException | NoSuchFieldException e) {
			return false;
		}

		return true;
	}

	public void sendMessage(String arg0) {
		Bukkit.getConsoleSender().sendMessage(ChatColor.translateAlternateColorCodes('&', arg0));
	}

	@Override
	public void onEnable() {
		String version = Bukkit.getServer().getClass().getPackage().getName().split("\\.")[3];

    	try {
    		CraftPlayer = Class.forName("org.bukkit.craftbukkit." + version + ".entity.CraftPlayer");
		} catch (ClassNotFoundException e) {
			sendMessage("&9[DisableInvulnerability] Could not load class!");
        	Bukkit.getPluginManager().disablePlugin(this);
        	e.printStackTrace();
        	return;
		}

        Bukkit.getPluginManager().registerEvents(this, this);
        sendMessage("&9[DisableInvulnerability] DisableInvulnerability has loaded!");
        sendMessage("&9[DisableInvulnerability] Server Version: " + version);
	}

    @EventHandler(priority=EventPriority.MONITOR)
    private void onPlayerJoin(PlayerJoinEvent event) {
		try {
			Object craftPlayer = CraftPlayer.cast(event.getPlayer());
			Object entityPlayer = event.getPlayer().getClass().getDeclaredMethod("getHandle").invoke(craftPlayer);

			if (fieldExists(entityPlayer.getClass(), "invulnerableTicks")) {
				entityPlayer.getClass().getField("invulnerableTicks").set(entityPlayer, 1);
			} else if (fieldExists(entityPlayer.getClass(), "cD")) {
				entityPlayer.getClass().getField("cD").set(entityPlayer, 1);
			} else {
				sendMessage("&9[DisableInvulnerability] Could not find invulnerableTicks field!");
				Bukkit.getPluginManager().disablePlugin(this);
			}
		} catch (IllegalAccessException | IllegalArgumentException | InvocationTargetException | NoSuchMethodException | SecurityException | NoSuchFieldException e) {
			e.printStackTrace();
		}
    }
}