package me.wobbychip.disableinvulnerability;

import java.lang.reflect.InvocationTargetException;

import org.bukkit.Bukkit;
import org.bukkit.ChatColor;
import org.bukkit.event.EventHandler;
import org.bukkit.event.EventPriority;
import org.bukkit.event.Listener;
import org.bukkit.event.player.PlayerJoinEvent;
import org.bukkit.plugin.java.JavaPlugin;

import net.minecraft.server.level.EntityPlayer;

public class Main extends JavaPlugin implements Listener {
	public Class<?> CraftPlayer;

	public void sendMessage(String arg0) {
		Bukkit.getConsoleSender().sendMessage(ChatColor.translateAlternateColorCodes('&', arg0));
	}

	@Override
	public void onEnable() {
		String version = Bukkit.getServer().getClass().getPackage().getName().split("\\.")[3];

    	try {
    		CraftPlayer = Class.forName("org.bukkit.craftbukkit." + version + ".entity.CraftPlayer");
		} catch (ClassNotFoundException e) {
			sendMessage("&9[DisableInvulnerability] Could not load class!");
        	Bukkit.getPluginManager().disablePlugin(this);
        	e.printStackTrace();
        	return;
		}

        Bukkit.getPluginManager().registerEvents(this, this);
        sendMessage("&9[DisableInvulnerability] DisableInvulnerability has loaded!");
        sendMessage("&9[DisableInvulnerability] Server Version: " + version);
	}

	@EventHandler(priority = EventPriority.MONITOR)
	private void onPlayerJoin(PlayerJoinEvent event) {
		try {
			Object craftPlayer = CraftPlayer.cast(event.getPlayer());
			EntityPlayer entityPlayer = (EntityPlayer) event.getPlayer().getClass().getDeclaredMethod("getHandle").invoke(craftPlayer);
			entityPlayer.cE = 1; //entityPlayer.e -> spawnInvulnerableTime
		} catch (IllegalAccessException | IllegalArgumentException | InvocationTargetException | NoSuchMethodException | SecurityException e) {
			e.printStackTrace();
		}
	}
}